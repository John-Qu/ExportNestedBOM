# SolidWorks 装配文件 BOM 表处理与 PDF 生成需求规格说明书

版本：v1.0
作者：项目开发
状态：草案（待评审）
最近更新：2025-09-19

1. 背景与目标
- 背景
  - 已能将 SolidWorks 装配文件的 BOM（物料清单）导出为多份 Excel 表格。
  - 需要对这些 Excel 表按统一规范进行格式整理，并批量生成 PDF，支持汇总统计与分类输出。
- 目标
  - 自动完成 Toolbox 英文名到中文名的替换与字段回填。
  - 统一整理列顺序、列标题、对齐方式、字体格式、打印区域与页眉页脚。
  - 使用 PDFCreator 将每个工作表导出为 PDF。
  - 对“顶层装配体_汇总”驱动的“总 BOM 汇总”进行每行信息统一汇总、去重与分类，并输出 PDF。
  - 对主模型 PDF，将其下属子装配工程图 PDF 与清单自动合并生成完整装配用清单。

2. 术语与缩写
- BOM：物料清单
- Toolbox：SolidWorks Toolbox 库件
- 顶层装配体\汇总：顶层装配对应的“汇总”Excel（文件名以“_汇总”结尾）
- 子装配：与顶层装配同目录下，不以“汇总”结尾的其他装配清单 Excel

3. 适用范围与运行环境
- 适用对象：SolidWorks 装配导出的 Excel 清单及其汇总。
- 运行环境：
  - 生产环境 Windows 10；测试环境 macos 上 parallel desktop 里的 Windows 11
  - 生产环境 Microsoft Excel 2016；测试环境：windows虚拟机内 WPS（含 VBA 插件）
  - PDFCreator（支持 COM 自动化）
  - SolidWorks 2019（用于前置导出，不参与 Excel 整理环节）

4. 输入与输出
- 输入
  - 多个 BOM Excel 文件，列结构固定为 A-R：
    A 文档预览，B 序号，C 零件号，D 代号，E 名称，F 数量，G 材料，H 处理，I SUPPLIER，J 型号，K 零件名称，L 规格，M 标准，N 备注，O 是否组装，P 是否外购，Q 是否机加，R 是否钣金。
  - 对照表："FomatBOM_ExportPDF.xlsm" 工作簿中“ToolboxNames”工作表，A 列=英文名，B 列=中文名。
  - 顶层汇总表：文件名含“汇总”的 Excel。
- 输出
  - 规范化后的 Excel（用于检查与复用）
  - 每个工作表对应的 PDF 文件（A4 横向，高质量，无缩放）
  - 主模型对应的合并 PDF（包含其下属子装配 PDF）

5. 业务规则与处理流程
5.1 单个 BOM 表的整理流程
- S1 装载对照表
  - 打开 "FomatBOM_ExportPDF.xlsm" 工作簿中“ToolboxNames”工作表，建立映射字典：英文名(A) -> 中文名(B)。
  - 注意，有些英文名中含有换行符，可能需要特别处理，例如“Hexagon Head Bolt-Full \n Thread-Product Grade C”中的“\n”就是换行。
- S2 Toolbox 名称替换与字段回填
  - 对每一行，若该行的“零件名称”（K 列）命中映射表（为 Toolbox 导出英文名）：
    - 将中文名写入 E 列“名称”。
    - 将 L 列“规格”复制到 J 列“型号”。
    - 将 M 列“标准”复制到 I 列“SUPPLIER”（稍后会改名为“渠道”）。
  - 未命中者,本行底色标黄提示缺少映射关系。
- S3 列标题重命名（首行）
  - O “是否组装” -> “组”
  - P “是否外购” -> “购”
  - Q “是否机加” -> “加”
  - R “是否钣金” -> “钣”
  - I “SUPPLIER” -> “渠道”
  - G 若显示为“材     料”（含空格） -> 规范为“材料”
- S4 列位置调整（整表）
  - 将 C 列“零件号”移动到首列（新 A 列）。
  - 将 O、P、Q、R 四列整体前移到 J 列“型号”之后。
  - 将 N 列“备注”移动到“零件名称”（K）之前。
  - 调整后的最终列序（从 A 到 R）应为：
    - A 零件号
    - B 文档预览
    - C 序号
    - D 代号
    - E 名称
    - F 数量
    - G 材料
    - H 处理
    - I 渠道（原 SUPPLIER）
    - J 型号
    - K 组（原 O）
    - L 购（原 P）
    - M 加（原 Q）
    - N 钣（原 R）
    - O 备注（已移动至零件名称之前）
    - P 零件名称
    - Q 规格
    - R 标准
- S5 布尔显示图标化
  - 在 K/L/M/N（组/购/加/钣）四列中，将单元格值符合以下任一条件者（忽略大小写与空白）:"是", "yes", "y", "j", "shi", "要"，统一替换为"●"；否则替换为"X"。
  - 注意：为保证显示一致性，应使用 Unicode 符号（非图片，字体需支持）。
  - 外购件：L="●"
  - 钣金件：N="●"
  - 模型件：M="●"
  - 先主模型，再按 BOM 嵌套顺序追加子装配(“组”列值为"●") PDF。
  - 关键词（分类工作表）：["●"]（可配置）
  - 图标字符：真="●"，假="X"（可配置；若字体不支持，可切换为“✔/✘”）
- S6 字体与对齐
  - 全表字体：汉仪长仿宋体，字号 14，常规。
  - 首行标题：加粗，水平居中，垂直居中。
  - 内容对齐：
    - 左对齐：D 代号、J 型号、H 处理、O 备注
    - 右对齐：F 数量
    - 中对齐：其余列
  - 列宽设置：
    - A 零件号 27
    - B 文档预览 17
    - C 序号 7
    - D 代号 15.5
    - E 名称 12
    - F 数量 7
    - G 材料 15
    - H 处理 10
    - I 渠道（原 SUPPLIER） 12
    - J 型号 20
    - K 组（原 O）4
    - L 购（原 P）4
    - M 加（原 Q）4
    - N 钣（原 R）4
    - O 备注（已移动至零件名称之前） 20
- S7 打印与分页设置
  - 打印区域：B:O（从“文档预览”到“备注”），行数覆盖有内容的最后一行。
  - 标题行重复：首行。
  - 去掉所有边框线（无外框）。
  - 页眉：
    - 左：清单所在文件夹名称
    - 中：当前文件名称
    - 右：当前 xls 文件的最后修改日期
  - 页脚：
    - 中：第 &[页码] 页，共 &[总页数] 页
  - 页面设置：A4，横向，缩放=100%（无缩放），高质量打印，打印所有工作表。
- S8 PDF 导出
  - 使用 PDFCreator 通过 COM 控制导出为 PDF。
  - 文档属性：
    - Title：“所在文件夹名 本文件名”
    - Author：操作系统用户名
    - Subject：所在文件夹名
  - 输出目录：与源 Excel 同级的默认“PDF”子目录，或按配置。
  - 文件命名：与工作表名称一致。

5.2 总汇总数据处理（独立程序）
- G1 索引与扫描范围
  - 以“顶层装配体\汇总”工作簿为驱动，遍历其“汇总”工作表的每一数据行，读取 A 列“代号”作为索引键 key。
  - 对此索引键 key，读取对应 C 列的“总数量”，D 列“分解链”，存储为相应字典值。
  - 扫描同一目录下所有不以“汇总”结尾的装配清单文件（子装配 BOM）。
- G2 匹配与复制
  - 在每个子装配 BOM 的数据工作表内，定位“零件号”列，查找等于 key 的行（精确匹配）。
  - 如找到，将该行（按本规范最终列序）各列内容存为相应字典值。
  - 若多个文件内某行匹配同一个 key，可按“首次出现优先”保留单一行的描述性字段。
- G3 数量汇总与去重
  - 总数量 = “顶层装配体_汇总”的“总数量”（C 列）。
  - 在新建的“总 BOM 清单”工作表中：
    - 对每个 key，按本规范最终列序，仅输出一行记录。
    - 注意，1. 其“数量”列填入“总数量”。2. 在“备注”列的右侧新增一列“计算说明”，“分解链”的内容。
- G5 列与格式
  - “总 BOM 清单”采用与单表一致的列结构与格式规范（见 5.1 的 S3-S7）。
  - 如源列序不同，按本规范最终列序输出。
- G6 分类输出工作表
  - 从“总 BOM 清单”中基于 K/L/M/N（组/购/加/钣）四列生成以下分类工作表：
    - 外购件：L="◉"
    - 钣金件：N="◉"
    - 模型件：M="◉"
  - 外购件工作表额外需求：
    - 按“渠道”（I 列）进行筛选与排序（先按渠道、再按代号）。
  - 分类表同样按 5.1 的 S6-S8 规范化并导出 PDF。
- G7 合并 PDF
  - 对以主模型名称命名的 PDF，将其目录下子装配生成的 PDF 按装配层级顺序合并为一份总 PDF。
  - 合并顺序规则：
    - 先主模型，再按 BOM 嵌套顺序追加子装配(“组”列值为"◉") PDF。
  - 合并工具：优先使用 PDFCreator 的合并队列；如受限，可使用配置的外部合并库。

5.3 配置项
- 映射表路径： "FomatBOM_ExportPDF.xlsm"
- 映射表工作表名：ToolboxNames
- 关键词（分类工作表）：["◉"]（可配置）
- 布尔真值集合：["是", "yes", "y", "j", "shi", "要"]（大小写不敏感，可配置）
- 图标字符：真="◉"，假="✕"（可配置；若字体不支持，可切换为“✔/✘”）
- 字体：汉仪长仿宋体（可配置为备用字体）
- PDF 输出目录：默认“PDF/”
- PDF 合并策略：按层级或名称排序（可配置）
- 打印设置：A4 横向，100% 缩放，高质量（可配置）

5.4 异常与兼容性处理
- 找不到“ToolboxNames”或映射表为空：跳过替换，记录警告日志。
- 字体“汉仪长仿宋体”不可用：回退为宋体或 Calibri，并记录警告。
- 列标题存在轻微差异（如大小写、空格）：允许容错匹配（模糊/别名表）。
- 子装配 BOM 中缺失“零件号/数量”等关键列：跳过该文件并在“计算说明”中标注缺失来源。
- PDFCreator 不可用：记录错误并输出 Excel 版作为替代。

5.5 性能与规模
- 支持单个 BOM 工作表 5,000 行以上的处理，整批 50 份工作表以内在 5 分钟内完成（i7/16GB/SSD 参考）。
- 合并 PDF 的时间与页数正相关，应逐步累加生成，避免一次性内存构建。

5.6 日志与可观测性
- 输出处理日志（文本或 CSV），包含：
  - 时间、文件、工作表、操作步骤、影响行数、警告/错误摘要。
- 对关键异常提供“可重试”提示，并保留中间产物（规范化后的 Excel）。
- 在每个关键子功能中添加调试代码，在立即窗口中输出处理对像或结果。

5.7 安全性与权限
- 程序仅访问工作目录及映射表所在目录，不访问其他系统资源。
- PDF 输出目录可写入校验；无权限时终止并提示。

5.8 验收标准与测试用例
- 用例 T1：Toolbox 名称替换
  - 输入："TS180-01Z-02Z 立柱平台" Sheet1 的 K 列为英文名“Hexagon Head Bolt-Full \n Thread-Product Grade C”，映射为“六角头螺铨全螺纹-C级”。
  - 期望：
    - E=“六角头螺铨全螺纹-C级”；
    - L 复制到 J；
    - M 复制到 I；
    - 其余不变。
    - 不在映射字典中的“Cup Head Nib Bolt”所在行，底色标黄。
    - 将本行的“是否外购”列内容标记为到“是”。
- 用例 T2：列调整与标题重命名
  - 期望：列顺序符合 5.1 S4；标题正确；G 标题去空格。
- 用例 T3：布尔图标化
  - 输入：O/P/Q/R 四列混合“是/Yes/y/j/空白/否”等。
  - 期望：K/L/M/N 四列仅出现“○/×”。
- 用例 T4：格式与打印
  - 期望：字体、对齐符合规范；打印区域=B:O；页眉/页脚内容正确。
- 用例 T5：PDF 导出
  - 期望：每个工作表生成 PDF；Title/Author/Subject 符合要求。
- 用例 T6：汇总数量计算
  - 输入：三份子装配清单同一 key 数量分别为 2/3/1。
  - 期望：总表该项数量=6；备注右侧“计算说明”写明来源/公式；仅复制一次描述性字段。
- 用例 T7：分类表
  - 期望：购（L=“●”）、钣（N=“●”）、加（M=“●”）（名称命中关键词）分别生成独立工作表并 PDF。
- 用例 T8：合并 PDF
  - 期望：主模型 PDF 合并子装配 PDF，顺序正确，无缺页。

1.  交付物
- 可执行的 Excel VBA 宏模块（或 VSTO/外部工具），含：
  - 单表整理模块
  - 总汇总处理模块
  - PDF 导出与合并模块
  - 配置模块与日志模块
- 使用说明与部署文档

1.  后续扩展（选项）
- 别名列映射配置（支持不同导出模板）。
- 渠道字段的数据验证与字典管理。
- PDF 模板化页眉页脚（含 Logo）。
