# SolidWorks BOM自动化处理系统需求规格说明书


## 1. 项目概述

### 1.1 目标

开发SolidWorks 2019 VBA程序，实现**BOM清单递归导出**、**零件数量递归统计**及**汇总表生成**，满足生产环境中对装配体层级结构拆解、零件用量核算的自动化需求。


## 2. 核心功能模块

### 2.1 BOM递归导出模块

#### 2.1.1 功能描述

- 触发方式：运行宏后通过文件选择窗口选定顶层装配体工程图。
- 递归逻辑：
  1. 导出当前工程图中第一张BOM清单为Excel文件（文件名=当前装配体名称，路径=会话输出目录）。
  2. 遍历BOM清单“是否组装”列（支持列别名：是否组装/Is Assembly/组装/是否组件/IS ASSEMBLY/组装体/ASSEMBLY），若值命中集合（大小写不敏感）：“是/YES/Y/TRUE/1/组装/装配”，则：
     - 从会话输出目录对应的工程图所在文件夹中，打开同名子装配体工程图（假设子装配体工程图文件名为“[子装配体名称].slddrw”）。
     - 对新打开的工程图重复步骤1（递归执行）。
  3. 终止条件：
     - “是否组装”列值不在上述集合。
     - 递归深度达到10层（默认，可配置范围1-20；超限后停止当前分支递归）。

#### 2.1.2 输出规范

- Excel文件内容：
  - 表头与列序与原BOM清单一致。
  - 若BOM包含缩略图列，则保留该列并导出为嵌入图片（清晰度以BOM原始缩略图为准）。
- 文件命名：
  - 顶层装配体：`[顶层装配体名称].xls`。
  - 子装配体：`[子装配体名称].xls`
  - 输出到会话目录（通常为工程图所在文件夹）。
- 文件操作：
  - 若同名 xls 已存在则跳过导出，不覆盖、不提示（记录日志）。

#### 2.1.3 异常处理

- 循环引用检测：递归过程中记录已处理的装配体路径，若再次遇到同一装配体，弹出对话框提醒“检测到循环引用：[装配体名称]”。
- 递归深度超限：达到10层时，在日志中记录“递归深度超限（>10层），已终止当前分支”（无需用户交互）。

### 2.3 汇总表生成模块

#### 2.3.1 功能描述

- 基于递归导出阶段采集到的BOM行数据，对相同零件进行合并计数（以“代号/零件号/图号/Part Number”等别名统一的标识列为键）。
- 仅统计底层零件行，忽略被判定为“是否组装”为真的装配行。
- 数量字段按配置的别名集合识别（如：数量/QTY/Qty/QUANTITY/数量(QTY)），并进行累加。

#### 2.3.2 输出规范

- 文件名：`[顶层装配体名称]_汇总.xls`（与顶层Excel文件同文件夹/会话目录）。
- 格式要求：采用HTML表格写入的xls（非CSV），不嵌入图片；兼容未激活Excel 2016。
- 文件操作：若同名 xls 已存在则跳过生成，不覆盖、不提示（记录日志）。

## 3. 系统约束

### 3.1 环境约束

- 运行环境：断网Windows 10专业版，SolidWorks 2019，未激活Office Excel 2016。
- 依赖限制：禁止调用Excel COM组件（避免跳出Excel激活弹窗），优先使用SolidWorks内置Excel导出API（需确保支持图片嵌入）。
- 递归深度：默认10层，可配置范围1-20（越界将拒绝设置）。

### 3.2 接口与依赖

- SolidWorks API：需调用以下接口（示例）：
  - `ISldWorks.OpenDoc4`：打开工程图。
  - `IDrawingDoc.GetBOMTables`：读取BOM表。
  - `IBOMTableAnnotation.SaveAsExcel`：导出Excel（支持包含图片）。
  - `IBOMTable.GetRowCount`/`GetColumnCount`：遍历BOM数据。
  - `IModelDoc2.SaveAs4`：导出Excel（需指定格式为.xlsx并嵌入图片）。


## 4. 数据流程

### 4.1 BOM递归导出流程

```mermaid
graph TD
    A[选择顶层工程图] --> B[导出顶层BOM为Excel]
    B --> C[遍历顶层BOM行]
    C --> D{是否组装?}
    D -- 是/Yes/y --> E[打开子装配体工程图]
    E --> F[导出子装配体BOM为Excel]
    F --> C[遍历子装配体BOM行]  // 递归
    D -- 否 --> G[终止当前分支]
```


### 4.2 数量统计流程

```mermaid
graph TD
    A[顶层BOM行] --> B{是否组装?}
    B -- 否 --> C[记录零件用量: Q0]
    B -- 是 --> D[进入子装配体BOM]
    D --> E[记录子装配体用量: K1]
    E --> F[子装配体BOM行]
    F --> G{是否组装?}
    G -- 否 --> H[记录零件用量: Q1 × K1]
    G -- 是 --> I[进入下一级子装配体, 记录用量K2]
    I --> J[零件用量: Q2 × K2 × K1]  // 累乘上级用量
    H --> Z[总数量=累乘结果]
    J --> Z
    C --> Z
```


## 5. 交付物

- 中间文件：每个装配体BOM导出的独立Excel文件（含缩略图）。
- 最终汇总表：`[顶层装配体名称]_汇总.xls`，包含所有底层零件的总数量及计算过程。

## 6. 技术约束

- Excel兼容性：需在未激活Excel 2016环境下生成可保存图片的.xls文件（使用SolidWorks内置导出功能，避免依赖Excel COM组件）。
- 文件路径：所有子装配体工程图必须与上级工程图在同一文件夹（程序不支持跨文件夹查找）。
- 缩略图嵌入：通过SolidWorks API直接导出带图片的Excel，确保图片不丢失。
- 测试验证：我有两个装配体文件，有嵌套关系，各有几个件，属性都完整清晰。我的编程环境是macOS，我有windows虚拟机，装有Solidworks 2019，我可以手工粘贴代码过去，跑各个子测试，我来看结果是否正确。
- 错误处理与日志：如果程序运行过程中出现错误，会在日志文件中记录详细错误信息，方便定位和修复；日志输出至 `%TEMP%` 目录，文件名形如 `ExportNestedBOM_YYYYMMDD_hhnnss.log`。