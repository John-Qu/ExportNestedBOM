# SolidWorks BOM自动化处理系统需求规格说明书


## 1. 项目概述

### 1.1 目标

开发SolidWorks 2019 VBA程序，实现**BOM清单递归导出**、**零件数量递归统计**及**汇总表生成**，满足生产环境中对装配体层级结构拆解、零件用量核算的自动化需求。


## 2. 核心功能模块

### 2.1 BOM递归导出模块

#### 2.1.1 功能描述

- **触发方式**：运行宏后通过文件选择窗口选定顶层装配体工程图。
- **递归逻辑**：
  1. 导出当前工程图中**第一张BOM清单**为Excel文件（文件名=当前装配体名称，路径=工程图所在文件夹）。
  2. 遍历BOM清单“是否组装”列，若值为“是”/“Yes”/“y”（不区分大小写？按用户原文直接匹配），则：
     - 从当前工程图所在文件夹中，打开同名子装配体工程图（假设子装配体工程图文件名为“[子装配体名称].slddrw”）。
     - 对新打开的工程图重复步骤1（递归执行）。
  3. **终止条件**：
     - “是否组装”列值不为“是”/“Yes”/“y”。
     - 递归深度达到**10层**（超限后停止当前分支递归）。


#### 2.1.2 输出规范

- **Excel文件内容**：
  - 第一列：嵌入SolidWorks文件缩略图（清晰度以BOM原始缩略图为准）。
  - 表头与原BOM清单一致。
- **文件命名**：
  - 顶层装配体：`[顶层装配体名称].xls`。
  - 子装配体：`[子装配体名称].xls`
  - 与装配体工程图同文件夹。
- **文件操作**：
  - 同名xls文件直接覆盖（无需提示）。


#### 2.1.3 异常处理

- **循环引用检测**：递归过程中记录已处理的装配体路径，若再次遇到同一装配体，弹出对话框提醒“检测到循环引用：[装配体名称]”。
- **递归深度超限**：达到10层时，在日志中记录“递归深度超限（>10层），已终止当前分支”（无需用户交互）。


### 2.2 零件数量递归统计模块

#### 2.2.1 统计对象

- **底层零件**：“是否组装”列值不为“是”/“Yes”/“y”的零件（需统计总数量）。
- **中间子装配体**：仅作为数量乘数载体，自身不进入最终汇总。


#### 2.2.2 计算逻辑

- **数量传递规则**：子装配体中的零件数量 = 零件在子装配体中的用量 × 子装配体在上一级的用量。
- **递归累乘公式**：底层零件总数量 = 零件在最底层子装配体中的用量 × 所有上级子装配体用量的乘积。
  ▶ 示例：零件在子装配体A中用量4，A在上层B中用量2，B在顶层中用量3 → 总数量=4×2×3=24。


#### 2.2.3 过程记录

- 在汇总表最后一列新增“计算过程”列，记录完整乘数链，格式为“[底层装配体A中用此零件量1]×[底层装配体A在上层装配体B中用量2]×...×[上层装配体N在顶层层装配体M中用量n] + [底层装配体P中用此零件量1]×[底层装配体P在上层装配体Q中用量2]×...×[上层装配体W在顶层层装配体M中用量n] =[总数量]”（如“4×2×3 + 3x5 = 39”）。


### 2.3 汇总表生成模块

#### 2.3.1 汇总内容

- **表头**：与顶层装配体BOM清单一致。
- **行数据**：仅包含所有底层零件，每行内容与顶层BOM对应列保持一致。
- **数量列**：填写底层零件的总数量（递归计算结果）。
- **计算过程列**：记录2.2.3中描述的乘数链文本。


#### 2.3.2 输出规范

- **文件名**：`[顶层装配体名称]_汇总.xls`（与顶层Excel文件同文件夹）。
- **格式要求**：支持图片保存（非CSV文本），兼容未激活Excel 2016。


## 3. 系统约束

### 3.1 环境约束

- **运行环境**：断网Windows 10专业版，SolidWorks 2019，未激活Office Excel 2016。
- **依赖限制**：禁止调用Excel COM组件（避免跳出Excel激活弹窗），优先使用SolidWorks内置Excel导出API（需确保支持图片嵌入）。


### 3.2 接口与依赖

- **SolidWorks API**：需调用以下接口（示例）：
  - `ISldWorks.OpenDoc4`：打开工程图。
  - `IDrawingDoc.GetBOMTables`：读取BOM表。
  - `IBOMTable.GetRowCount`/`GetColumnCount`：遍历BOM数据。
  - `IModelDoc2.SaveAs4`：导出Excel（需指定格式为.xlsx并嵌入图片）。


## 4. 数据流程

### 4.1 BOM递归导出流程

```mermaid
graph TD
    A[选择顶层工程图] --> B[导出顶层BOM为Excel]
    B --> C[遍历顶层BOM行]
    C --> D{是否组装?}
    D -- 是/Yes/y --> E[打开子装配体工程图]
    E --> F[导出子装配体BOM为Excel]
    F --> C[遍历子装配体BOM行]  // 递归
    D -- 否 --> G[终止当前分支]
```


### 4.2 数量统计流程

```mermaid
graph TD
    A[顶层BOM行] --> B{是否组装?}
    B -- 否 --> C[记录零件用量: Q0]
    B -- 是 --> D[进入子装配体BOM]
    D --> E[记录子装配体用量: K1]
    E --> F[子装配体BOM行]
    F --> G{是否组装?}
    G -- 否 --> H[记录零件用量: Q1 × K1]
    G -- 是 --> I[进入下一级子装配体, 记录用量K2]
    I --> J[零件用量: Q2 × K2 × K1]  // 累乘上级用量
    H --> Z[总数量=累乘结果]
    J --> Z
    C --> Z
```


## 5. 交付物

- **中间文件**：每个装配体BOM导出的独立Excel文件（含缩略图）。
- **最终汇总表**：`[顶层装配体名称]_汇总.xlsx`，包含所有底层零件的总数量及计算过程。


## 6. 技术约束

- **Excel兼容性**：需在未激活Excel 2016环境下生成可保存图片的.xls文件（优先使用SolidWorks内置导出功能，避免依赖Excel COM组件）。
- **文件路径**：所有子装配体工程图必须与上级工程图在同一文件夹（程序不支持跨文件夹查找）。
- **缩略图嵌入**：通过SolidWorks API直接导出带图片的Excel，确保图片不丢失。
- **测试验证**：我有两个装配体文件，有嵌套关系，各有几个件，属性都完整清晰。我的编程环境是macOS，我有windows虚拟机，装有Solidworks 2019，我可以手工粘贴代码过去，跑各个子测试，我来看结果是否正确。
- **错误处理**：如果程序运行过程中出现错误，会在日志文件中记录详细错误信息，方便定位和修复。


### 2.x 前置模块：自定义属性批量添加/更新
#### 2.x.1 功能描述
- 目的：在BOM导出/数量统计前，统一补齐与规范模型自定义属性
- 支持模式：单文件处理、文件夹批量处理（*.sldprt、*.sldasm）
- 交互：弹窗确认“当前文件/批量处理”；随后进入“属性确认窗体”逐项可编辑与勾选导入

#### 2.x.2 属性清单与来源
- 解析/计算：
  - 名称（从文件名“代号 空格 名称”中切分）
  - 代号（同上）
  - 项目代号/项目名称（从父文件夹名中按“项目代号_项目名称”解析）
  - 质量（kg，三位小数；通过MassProperty计算）
  - 是否钣金（零件类型判定，装配体恒为否）
  - 设计（Windows用户：ENV USERNAME）
  - 定型日期（文件创建日期 yyyy-mm-dd）
- 读取（若存在则回填）：
  - 型号、SUPPLIER（优先“配置特定”，否则“自定义”）

#### 2.x.3 写入策略与范围
- 同步写入两处：自定义（文档级），配置特定（当前配置）
- 强制写入法：Delete 旧项 → Add2(文本类型, 值)，避免新增失败与残留状态影响

#### 2.x.4 批量处理流程
1) 遍历目标文件夹的 *.sldprt、*.sldasm
2) 若未打开则静默打开 → 构建属性数组 → 弹出确认窗体
3) 用户点击“Add/Update”则写入并保存；“Skip”跳过；“Cancel”中止批量
4) 若是临时打开的文件则处理后关闭
5) 完成后弹出统计（总计/已更新/已跳过/用户中止）

#### 2.x.5 成功判定与日志
- 成功：所勾选的属性项在文档级与配置特定均能读取到更新值
- 失败处理：提示只读/权限问题；质量为空或非钣金判定异常时不阻断流程

#### 2.x.6 UI要点
- 动态行：属性名 | 值（可编辑） | 导入（勾选）
- 支持全选/反选；窗体标题显示当前处理文件名