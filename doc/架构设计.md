# 架构设计

本文说明 ExportNestedBOM 在 Excel 侧与 SolidWorks 侧的整体架构、模块关系、数据流与关键约束，帮助快速理解系统边界与协作方式。

总体结构
- 双端协作：
  - SolidWorks 侧负责生成规范的 BOM 数据与自定义属性（可选）。
  - Excel 侧负责对 BOM 进行合并、格式化、汇总与输出（PDF/打印）。
- 以 Excel 工作簿为中心：合并后的顶层装配工作簿是主要数据载体，所有格式化与汇总动作都在此执行。

模块关系（Excel 侧）
- Main.bas：
  - 调度入口（Run_* 系列），串联合并→格式化→汇总→导出的流水线。
- SingleSheetFormatter.bas：
  - 标题识别与标准化；列序重排；布尔列图标化；字体与对齐；打印设置；末尾无预览行清理；备注列保障。
- SummaryProcessor.bas：
  - 以“汇总”为驱动构建“总 BOM 清单”，从当前工作簿的子装配工作表中检索数据。
- PdfExport.bas：
  - 将每个可见工作表单独导出为 PDF；或分表打印。
- Utils.bas：
  - 通用工具（路径、列定位、工作簿/工作表操作、字符串规格化、最后行/列识别）。
- Logger.bas：
  - 统一日志：Info/Warn/Error。
- Config.bas：
  - 统一配置：标题扫描上限、布尔真值集合、字体/打印、PDF 输出等。

模块关系（SolidWorks 侧）
- UpdateProperties.bas：
  - 批量添加/更新模型与工程图的自定义属性，为 Excel 侧流程提供一致的数据基础。
- Main/RecursiveProcessor/Utils/Logger 等：
  - 递归导出与辅助工具（与 Excel 侧相互独立，可按需使用）。

数据流
1) 子装配清单准备（SolidWorks 侧或已有 Excel）
2) Excel 打开目标工作簿 → Run_Merge_SubBOMs_Into_CurrentWorkbook 合并所有子装配表
3) Run_Format_AllVisibleSheets：
   - 标题统一、列序重排、布尔图标、打印设置、末尾无预览清理、备注列保障
4) 在“汇总”表准备好关键字段 → Run_Generate_TotalBOM_FromSummary：
   - 遍历当前工作簿的子装配工作表，按 key 查找行，生成“总 BOM 清单”
5) Run_Export_AllSheets_ToPDF 或 Run_Print_AllSheets_Separately

关键约束与约定
- 列标题别名：通过 NormalizeName 与别名表进行匹配。
- 列序规范：最终列序固定；若缺失“备注”且存在“零件名称”，自动在其前插入“备注”。
- 预览判定：
  - 文本非空即有预览；否则检查形状/OLE 对象中心点落入单元格。
  - 仅清理末尾连续无预览行，避免误删中间数据。
- 总 BOM 来源：仅遍历当前工作簿可见工作表，排除“汇总”“总 BOM 清单”。
- 跨平台路径：统一 Application.PathSeparator。

扩展点
- 预览判定由“中心点”升级为“矩形相交”。
- 汇总匹配策略支持多键与模糊匹配。
- 处理流程参数化（是否执行清理/插入备注等）。

质量保障
- 日志全程记录关键决策；遇到列缺失等异常输出诊断信息。
- 通过 test/MY2502_测试模型 进行回归验证。