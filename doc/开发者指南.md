# 开发者指南

本文面向项目维护者与贡献者，概述项目结构、主要模块职责、关键算法、编码规范、日志与错误处理约定，以及本仓库内已实现的差异点（与初版需求相比）。

项目结构
- excel_src/
  - Main.bas：入口过程与调度（格式化、合并、总 BOM、PDF/打印）
  - SingleSheetFormatter.bas：单表标准化（标题重命名、列序、布尔图标、字体与对齐、打印设置、末尾无预览行清理、备注列保障）
  - SummaryProcessor.bas：从“汇总”生成“总 BOM 清单”（遍历当前工作簿工作表，跳过“汇总”“总 BOM 清单”）
  - PdfExport.bas：分表导出 PDF（文件名=工作表名）
  - Utils.bas：通用方法（列查找、路径拼接、工作簿/工作表工具）
  - Config.bas：配置项（真值集合、打印/PDF配置、扫描上限等）
  - Logger.bas：日志输出
- SW_src/
  - UpdateProperties.bas：SolidWorks 侧批量添加/更新自定义属性
  - 其余：递归导出、日志、配置等（与 Excel 侧相互配合）

关键设计与算法
1) 标题识别与列序
   - 通过别名词典进行标题识别（NormalizeName 统一大小写/空格），在 DetectHeaderRow 中尝试多行打分，选出最佳表头行。
   - 列序重排时采用剪切列并插入到目标位置的策略，避免重建整表。
   - 特殊修复：若“数量”标题为空且位于“名称”右侧一列，自动补齐“数量”。
   - 备注列保障：若缺少“备注”且存在“零件名称”，在其前插入空白“备注”，确保最终列序与规范一致。

2) 布尔列图标化
   - 以 CFG_TRUE_SET() 构造真值集合字典，支持“是/Yes/Y/1/True”等。
   - 对“组/购/加/钣”逐行替换为 ICON_TRUE/ICON_FALSE，避免重复写入。

3) 末尾无预览行清理
   - 基于“文档预览”列：文本非空即视为有预览；否则检查 Shapes/OLEObjects 的中心点是否落在单元格内。
   - 自末尾向上删除连续的“无预览”行，不影响中间数据行。

4) 总 BOM 构建（与初版差异）
   - 初版：扫描文件系统以收集 BOM 工作簿。
   - 当前：仅扫描当前合并后的工作簿中可见工作表，跳过“汇总”与“总 BOM 清单”。可通过 skipSheets 参数扩展。

5) 路径兼容
   - 统一使用 Application.PathSeparator 进行路径拼接；禁止硬编码“/”或“\”。

日志与错误处理
- Logger 模块统一输出 Info/Warn/Error。
- 遇到关键列缺失时输出诊断（包括表头行的局部转储），便于定位。
- 关键过程使用 On Error GoTo FAIL 模式，写日志后优雅退出。

编码规范
- 模块化职责分离；函数命名以动宾短语为主（动词+名词）。
- 避免全局变量滥用；配置通过 Config 暴露；路径通过 Utils 统一。
- 跨平台：尽量使用 Excel/Office 提供的常量与属性（如 PathSeparator）。

构建与发布
- 本仓库为 VBA 源文件集合；在 Excel/SolidWorks 的 VBA 编辑器中导入并运行。
- 不建议提交包含真实密钥/路径的配置。

测试建议
- 使用 test/MY2502_测试模型 进行回归：
  - 合并子装配并格式化 → 检查列序、图标化、末尾清理、备注列插入
  - 生成总 BOM → 检查是否仅从子装配工作表取数
  - 导出 PDF/打印 → 检查文件命名与页码

未来可扩展方向
- 预览判定由“中心点落入”改为“重叠即命中”的矩形相交判断
- 总 BOM 的匹配策略支持多关键字段与模糊匹配
- 格式化流程提供开关（是否清理末尾/是否插入备注/是否强制列序）