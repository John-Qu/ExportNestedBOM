# 使用AI生成SolidWorks工程图BOM清单导出Excel的VBA程序——项目复盘（软件工程最佳实践版）

## 1. 项目概述
- 目标：将 SolidWorks 工程图的 BOM 清单导出到 Excel，支持递归处理子装配并汇总数量。
- 背景：在 Mac 的 Windows 虚拟机中开发与测试，借助多模型（O3/Claude/GPT-5/TRAE）多轮迭代生成与修复代码。
- 结果：生产环境已稳定运行；支持多工作表或单文件导出策略；中文编码问题已解决；尚有防错与深度测试待补。
- 核心经验：
  - **对关键任务使用最强模型，对小改用响应快的模型**
  - **以清晰的书面需求驱动生成，文档作为单一事实来源**
  - **避免在对话式界面反复修补旧代码，必要时从头生成**
  - **模块化与文档化保障可维护性，尽早引入版本控制（Git）**
## 2. 范围与成功标准
### 2.1 范围
- 必做范围
  - 从顶层装配递归到子装配、子子装配，生成 BOM。
  - 支持导出 Excel：单文件多工作表，或单文件后续在 Excel 内部宏汇总。
  - 以“零件号/代号”为主键进行数量汇总，可配置显示项（如仅显示代号）。
  - 在目标生产环境完成部署并可靠运行。
- 非目标（当前阶段不强制）
  - 自动处理 Excel 激活/授权与跨版本的全部兼容细节（采用规避策略）。
  - 全量防错覆盖（将分阶段补齐）。
### 2.2 成功标准
- **递归正确性**：以“零件号”为唯一键，正确关联与进入子装配工程图。
- **可运行性**：生产机运行无需人工干预（不被 Excel 激活弹窗阻塞）。
- **可维护性**：低耦合模块化、配置外置、文档完整、变更可控。
## 3. 相关方与环境
### 3.1 相关方
- 我（需求/实现/测试）
- IT 经理（上传/部署/运维）
- 模型与平台：O3、Claude 4、GPT-5、TRAE（国际版/国内版）
### 3.2 运行环境
- Mac 上的 Windows 虚拟机
- SolidWorks（含工程图与 BOM）
- Excel 2016（生产机未激活引发弹窗）
- 语言与技术栈：VBA（SolidWorks/Excel 自动化）
### 3.3 工具与流程
- 需求沉淀：Google/本地 doc 文件夹
- Prompt 组装与多轮生成：flowith、TRAE
- 版本管理：后期引入 Git（早期缺失）
- 文档体系：需求说明、测试文档、部署说明、项目小结
## 4. 时间线与里程碑
1. 需求梳理与初版生成：多模型协作，代码演进至约 1225 行，虚拟机跑通。
2. 生产部署失败：提示“有一个程序正在运行”，无法正常打开 Excel。
3. 关键问题定位：**Excel 2016 未激活弹窗阻塞 COM 自动化**。
4. 策略调整：**改为单文件导出，汇总在 Excel 内部宏完成**，避免多次触发激活。
5. 重构尝试：Claude 4 缩减到 800+ 行但不稳定，随后转向**从头生成**。
6. 需求标准化：doc 文件夹撰写规范需求，GPT-5 依最佳实践产出模块化代码与文档。
7. 生产修复：以“零件号”为唯一键修正递归；**编码问题一行变更解决**；生产可用。
8. 待办：防错测试、递归深度>10层报警测试、完善 Git 与自动化流程。
## 5. 解决方案架构
### 5.1 模块划分
- 数据访问与解析：读取工程图 BOM，解析层级与字段（零件号、数量等）。
- 递归遍历：依据零件号定位子装配工程图，支持最大深度（默认 10 层）。
- 汇总与计算：以零件号/代号为主键聚合数量，可配置显示项。
- 导出层：写入 Excel（单文件多工作表），支持切换导出策略。
- 配置与环境：路径、字段映射、递归深度、编码/地域/Excel 版本敏感设置。
- 日志与错误处理：异常捕获、缺失工程图提示、递归环路与深度保护。
### 5.2 架构原则
- **低耦合、高内聚**
- **配置外置，环境差异解耦**
- **最小变更优先，先保运行再优化**
## 6. 实施过程亮点与挑战
### 6.1 亮点
- **“从头生成”策略降低返工与上下文债务**
- **文档化驱动（doc/ 为单一事实来源）**，减少对对话上下文的依赖
- **生产环境差异采用业务规避**（单文件导出），快速恢复可用性
### 6.2 挑战
- 多模型切换导致上下文漂移，AI 无法读取本地最新代码。
- 字段混淆（零件号 vs 代号）致递归失败。
- 中文乱码（编码/保存格式不一致）。
- 缺少 Git 历史，回退困难；重构引入新缺陷。
## 7. 关键问题与根因分析
### 7.1 生产环境“有一个程序正在运行”
#### 7.1.1 现象
- 生产机无法正常打开 Excel，导出流程被阻塞。
#### 7.1.2 根因（5 Whys）
- 多文件合并策略多次启动 Excel
- Excel 2016 未激活弹窗阻塞后台 COM
- 设计时未考虑“未激活/受限 Office”环境差异
- 测试与生产环境不一致，缺少环境基线校验
#### 7.1.3 纠偏与预防
- **改为单文件导出，汇总在 Excel 内部宏完成**
- **部署清单加入 Excel 激活状态检查**
### 7.2 递归失败与字段混淆
#### 7.2.1 现象
- 仅生成顶层装配，无法进入子装配。
#### 7.2.2 根因
- 将“代号”误作“零件号”用于工程图匹配，导致找不到子装配。
#### 7.2.3 纠偏与预防
- **在生产 BOM 中补充“零件号”列，以零件号为唯一键递归**
- 字段名与主键在配置中定义并校验
### 7.3 中文乱码
#### 7.3.1 现象
- 汇总清单出现汉字乱码。
#### 7.3.2 根因
- 输出编码/保存格式与 Excel 解析不一致。
#### 7.3.3 纠偏与预防
- **采用最小变更的一行设置修正编码/保存方式**
- 避免引入冗长替代输出（如 HTML）造成维护负担
### 7.4 重构后不可用
#### 7.4.1 现象
- 行数缩减但产生新 Bug，测试与生产均失败。
#### 7.4.2 根因
- 缺少回归测试与兼容基线，激进重构缺乏上下文。
#### 7.4.3 纠偏与预防
- **优先“从头生成 + 明确需求 + 模块化”**
- 建立测试文档与样例数据包，执行回归验证
## 8. 测试与质量保证
### 8.1 已完成
- 功能测试：顶层与递归导出、数量汇总（按代号显示）。
- 环境测试：虚拟机通过；生产机通过（单文件导出规避）。
- 编码测试：中文乱码修复验证。
### 8.2 待补充
- **递归深度与环路检测**：超过 10 层报警并中止；环路识别。
- **缺失工程图报警**：缺图提示并标记不完整，防止错误汇总。
- **环境一致性**：Excel 激活、区域/语言、权限、路径可达性。
- **回归测试集**：关键用例在每次变更后必跑。
### 8.3 建议
- **以测试用例清单驱动开发（TDD/强测试先行）**
- 仓库中维护“最小可运行样本工程图 + BOM 样例 + 期望输出”，便于复现
## 9. 经验教训
- **关键任务用最强模型，小改用快速模型，混合编排提效**
- **需求以书面规范固化，不依赖对话上下文**
- **上下文复杂且债务高时，从头生成优于修补旧代码**
- **及早引入 Git 与语义化提交，确保可回滚**
- **环境差异是首要风险，上线前做环境基线校验**
- **主键选择至关重要，以零件号等稳定键驱动递归与汇总**
- **生产问题优先最小改动修复，先恢复可用再优化**
## 10. 工程实践与规范（可复用）
### 10.1 需求与文档
- docs/ 或 doc/ 存放需求说明（范围、字段定义、边界条件、样例）。
- 变更日志与决策记录（ADR），记录为何做/为何不做。
### 10.2 代码与架构
- 模块化拆分：数据解析/递归/汇总/导出/配置/日志。
- 配置与环境隔离：字段映射、路径、深度、导出策略参数化。
### 10.3 测试
- 单元/集成/回归用例清单；提供样例工程图与期望 Excel。
- 环境基线检查脚本/手册。
### 10.4 部署
- 部署手册：依赖项、权限、Excel 激活状态、自检步骤、回退方案。
- 首次启动的自检与日志收集指南。
### 10.5 协作与 AI 使用
- 提供完整上下文：需求文档、代码快照或 Diff、环境与样例。
- 关键变更使用强模型，保持同一会话或提供“状态快照”链接。
## 11. 后续改进计划（SMART）
- 防错与稳健性（1 周内）
  - 完成缺失工程图报警、递归环路检测、>10 层深度报警。
  - 将递归深度、主键字段、显示选项外置到配置文件。
- 测试体系（1 周内建立，持续维护）
  - 最小可复现数据包与固定回归用例。
  - 每次变更执行回归清单与记录结果。
- 版本与发布（本周内）
  - 初始化 Git 仓库，语义化提交与标签；为稳定版打 v1.0.0。
  - 发布到 GitHub，附运行环境声明、局限与复现指南。
- 部署与环境（3 天内）
  - 部署前检查清单：Excel 激活、区域/字体/权限/路径可达性。
  - 记录 TRAE 国际版订阅到期并取消自动续订，避免超支。
- 技术债与优化（2 周内）
  - 导出策略抽象（单文件/多文件切换）；编码与保存格式参数化。
  - 日志与错误报告：关键步骤打点与异常编码，输出到文件。
## 12. 风险与缓解
- 环境差异（Excel 版本/激活/语言）
  - 缓解：**部署前环境检查清单**，必要时采用单文件导出规避。
- 字段与数据质量（零件号缺失/混用代号）
  - 缓解：**字段必填与一致性校验**，失败即报警与跳过。
- 过度依赖单一模型或平台
  - 缓解：保留本地文档与样例；以可移植需求与测试驱动再生成。
- 版本不可回退
  - 缓解：**全面引入 Git**，小步提交与打标签。
## 13. 发布到 GitHub 的价值说明
- **复用的是领域知识、边界处理与工程化规范**，不仅是代码行本身。
- **可再生成不等于无价值**：高质量需求与样例能让任何模型更快更准地产出正确实现，减少沟通与试错成本。
- 附局限与适配指南，帮助他人迁移到其环境。
## 14. 开放问题
- 是否为未激活的机器提供“纯文件写出”的备选（CSV/OpenXML 直写 XLSX）？
- 如何在不牺牲可用性的前提下进一步压缩代码并保持可测试性？
- 是否引入安装器或一键部署脚本，降低生产机操作门槛？
## 总结
- **关键成功因素**：标准化需求驱动生成；为关键任务选择最强模型；以最小变更快速修复生产问题；模块化与文档化提高可维护性。
- **下一步重点**：补齐防错与深度测试；固化 Git 与回归流程；完成开源发布与环境适配指引。