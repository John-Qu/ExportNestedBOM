# 部署说明

**当前稳定版本：v1.0（2025-09-02）**

## 系统要求

### 硬件要求
- Windows 10 专业版（推荐）
- 内存：至少 8GB RAM
- 硬盘：至少 100MB 可用空间

### 软件要求
- **SolidWorks 2019** 或更高版本
- **.NET Framework 4.5** 或更高版本
- **Excel 2016**（可选，系统会使用SolidWorks内置Excel导出功能）

## 部署步骤

### 方法零：从GitHub获取（推荐）

1. **克隆或下载项目**
   - 访问项目GitHub仓库
   - 使用git克隆：`git clone https://github.com/YOUR_USERNAME/ExportNestedBOM.git`
   - 或直接下载ZIP压缩包

2. **使用预编译宏文件**
   - 直接使用 `src/ExportNestedBOM.swp` 文件
   - 在SolidWorks中：工具 > 宏 > 运行...
   - 选择下载的 `ExportNestedBOM.swp` 文件

### 方法一：通过SolidWorks宏编辑器部署

1. **打开SolidWorks**
   - 启动SolidWorks 2019
   - 确保程序完全加载

2. **打开宏编辑器**
   - 菜单：工具 > 宏 > 编辑...
   - 或按快捷键：Alt + F11

3. **创建新宏项目**
   - 在VBA编辑器中，右键点击"VBAProject"
   - 选择"插入" > "模块"

4. **导入源码文件**
   按顺序导入以下文件（复制粘贴代码内容）：
   ```
   src/Constants.bas      -> 模块1
   src/Configuration.bas  -> 模块2  
   src/Logger.bas        -> 模块3
   src/Utils.bas         -> 模块4
   src/RecursiveProcessor.bas -> 模块5
   src/Main.bas          -> 模块6
   ```

5. **保存宏项目**
   - 文件 > 保存
   - 建议保存为：`ExportNestedBOM.swp`

### 方法二：直接导入宏文件

1. **复制宏文件**
   - 将 `src/ExportNestedBOM.swp` 复制到SolidWorks宏目录
   - 默认位置：`%USERPROFILE%\Documents\SOLIDWORKS\Macros\`

2. **运行宏**
   - SolidWorks菜单：工具 > 宏 > 运行...
   - 选择 `ExportNestedBOM.swp`
   - 执行 `RunExportNestedBOM` 函数

## 安装宏源码（方法一：宏编辑器导入）

1. **打开SolidWorks**
   - 启动SolidWorks 2019
   - 确保程序完全加载

2. **打开宏编辑器**
   - 菜单：工具 > 宏 > 编辑...
   - 或按快捷键：Alt + F11

3. **创建新宏项目**
   - 在VBA编辑器中，右键点击"VBAProject"
   - 选择"插入" > "模块"

4. **导入源码文件**
   按顺序导入以下文件（复制粘贴代码内容）：
   ```
   src/Constants.bas      -> 模块1
   src/Configuration.bas  -> 模块2  
   src/Logger.bas        -> 模块3
   src/Utils.bas         -> 模块4
   src/RecursiveProcessor.bas -> 模块5
   src/Main.bas          -> 模块6
   ```

5. **保存宏项目**
   - 文件 > 保存
   - 建议保存为：`ExportNestedBOM.swp`

### 方法二：直接导入宏文件

1. **复制宏文件**
   - 将 `src/ExportNestedBOM.swp` 复制到SolidWorks宏目录
   - 默认位置：`%USERPROFILE%\Documents\SOLIDWORKS\Macros\`

2. **运行宏**
   - SolidWorks菜单：工具 > 宏 > 运行...
   - 选择 `ExportNestedBOM.swp`
   - 执行 `RunExportNestedBOM` 函数

5. 窗体与属性宏（可选但推荐）
   - 新增一个“用户窗体”，导入 `src/frmProps.frm`
   - 新增一个“模块”，导入 `src/UpdateProperties.bas`
   - 保存后可通过运行过程 `Run_AddCustomProps` 启动属性批量添加/更新界面

### 行动二：在 Excel 2016 部署（BOM表整理与PDF）

适用场景：对已导出的装配 BOM Excel 清单执行规范化、PDF 导出、总汇总与分类输出。

步骤：
1) 打开 Excel 2016 → Alt+F11 打开 VBA 编辑器
2) 右键工程 → 导入文件 → 选择 excel 目录下 .bas 文件（全部导入）
3) 关闭编辑器，Excel 菜单“开发工具” → 宏 → 运行：
   - Main.Run_FormatAndExport_CurrentWorkbook
   - Main.Run_BuildSummary_And_Export
   - Main.Run_FullPipeline

宏安全设置（首次使用）：
- 文件 → 选项 → 信任中心 → 信任中心设置 → 宏设置 → 选“禁用所有宏并通知”或“启用所有宏（不推荐）”
- 将工程所在路径加入“受信任的位置”可避免警告提示

Excel 模块配置（位于 Config.bas）：
- CFG_MAPPING_WORKBOOK_PATH：映射表路径（支持相对路径，基于当前工作簿目录）
- CFG_MAPPING_SHEET：映射表工作表名（默认 ToolboxNames）
- CFG_BooleanTrueValues：布尔真值集合（是/yes/y/j）
- CFG_Icon_True / CFG_Icon_False：布尔展示符号（○/×）
- CFG_Font_Primary / CFG_Font_Fallback：主/备用字体
- CFG_PDF_OutputDir：PDF 输出目录（默认 PDF/）
- CFG_Page_*：页面设置（A4、横向、缩放=100%）
- CFG_Enable_PDFCreator_Merge：是否启用 PDFCreator 合并（检测不到 COM 时自动降级）

注意事项：
- 列标题容错：内置别名与“材 料”→“材料”的修正
- 打印区域：B:O，标题行重复第 1 行，页眉页脚内容为“目录名/文件名/文件修改日期”和“第x页/共y页”
- PDF 导出：默认使用 ExportAsFixedFormat；如需合并，请在 PdfExport.TryMergePdfs 中按本机 PDFCreator 版本补全接口
- 日志输出：运行日志以 run-时间戳.txt 生成到工作簿同级 logs/ 目录

新增：针对“宏在 FomatBOM_ExportPDF.xlsm，处理其他已打开 xls 清单”的运行方式
- 适用：测试/生产场景下，宏工作簿（含 VBA 代码）为 FomatBOM_ExportPDF.xlsm，而要处理的是同目录下或其他目录中已打开的 .xls 文件。

1) 放置与导入
- 打开 FomatBOM_ExportPDF.xlsm；在其中导入 excel_src 目录下的 5 个模块：Config.bas、Logger.bas、Utils.bas、SingleSheetFormatter.bas、Main.bas
- 在 FomatBOM_ExportPDF.xlsm 中准备映射表工作表 “ToolboxNames”：A 列=英文名，B 列=中文名

2) 打开目标
- 打开需要处理的 BOM 清单 .xls 文件（例如 “TS180-01Z-01Z 四柱平台.xls”、“TS180-01Z-02Z 立柱平台.xls”），保持它们与 FomatBOM_ExportPDF.xlsm 同时处于“已打开”状态

3) 运行入口
- 在 FomatBOM_ExportPDF.xlsm 中，Excel 菜单“开发工具” → 宏，运行以下之一：
  - Main.T1_Run_ToolboxReplace_ActiveSheet：仅处理目标工作簿的活动工作表
  - Main.T1_Run_ToolboxReplace_AllVisibleSheets：处理目标工作簿的所有“可见”工作表

4) 目标工作簿选择规则
- 若当前 ActiveWorkbook 不是 FomatBOM_ExportPDF.xlsm，则以当前 ActiveWorkbook 作为目标工作簿；
- 否则自动选择任一已打开且名称不为 FomatBOM_ExportPDF.xlsm 的工作簿作为目标。

5) 映射表来源与容错
- 优先从 FomatBOM_ExportPDF.xlsm 的 “ToolboxNames” 工作表加载映射（英文名→中文名）；
- 若宏工作簿未打开该映射，程序将尝试从“目标工作簿所在目录”加载同名文件 FomatBOM_ExportPDF.xlsm 并读取；
- 程序会自动对英文名中的换行与空格进行规范化（例如“\n”会被视为空格）。

6) 日志与结果确认
- 日志输出到“目标工作簿同级”的 logs/ 目录，文件名形如 “T1-yyyymmdd-hhnnss.txt”；
- 每张表处理完成后日志会打印统计：replaced=替换条数，unmatched=未匹配条数；
- 未匹配的行会以淡黄色（RGB 255,255,204）高亮，便于人工复核。

常见问题：
- 提示“未找到可处理的目标工作簿”：请先打开要处理的 .xls 文件；
- 提示“Mapping workbook not found”或“Mapping sheet not found”：请确认 FomatBOM_ExportPDF.xlsm 中存在工作表 “ToolboxNames” 且数据从第2行开始；
- 未找到列标题：请检查目标表第一行是否包含“零件名称/规格/标准/名称/型号/SUPPLIER”等（支持中英文与常见别名）。

## 运行属性批量添加/更新宏（前置准备）
- 打开SolidWorks → 工具 → 宏 → 运行 → 选择包含上述窗体与模块的宏工程
- 运行 `Run_AddCustomProps`，根据弹窗选择“处理当前打开文件”或“选择文件夹批量处理”
- 在属性确认窗体中逐项编辑并勾选需要导入的属性，点击“Add/Update”写入
- 写入策略：同时写入“自定义（文档级）”与“配置特定（当前配置）”，使用Delete+Add2文本类型

### 1. 测试SolidWorks API连接
```vba
' 在SolidWorks VBA编辑器中执行以下代码进行测试
Sub TestConnection()
    Dim swApp As Object
    Set swApp = Application.SldWorks
    If swApp Is Nothing Then
        MsgBox "无法连接到SolidWorks"
    Else
        MsgBox "SolidWorks连接成功，版本：" & swApp.RevisionNumber
    End If
End Sub
```

### 2. 验证文件权限
确保以下目录具有读写权限：
- 工程图文件所在目录
- 系统临时目录：`%TEMP%`
- SolidWorks安装目录

## 使用前准备

### 1. 文件结构要求
```
项目文件夹/
├── 顶层装配体.slddrw       (必需)
├── 子装配体1.slddrw        (如有子装配体)
├── 子装配体2.slddrw        (如有子装配体)
└── 零件文件.sldprt         (可选)
```

### 2. BOM表格式要求
- 工程图必须包含**BOM表**
- BOM表必须包含以下列（列名支持中英文）：
  - **数量列**："数量", "QTY", "Qty"
  - **零件号列**："代号", "PART NUMBER", "Part Number"
  - **名称列**："名称", "PART NAME", "Name"
  - **是否组装列**："是否组装", "Is Assembly"（位于最右侧）

### 3. "是否组装"列标记规范
- **组装体**：填写 "是", "Y", "YES", "TRUE", "1"
- **零件**：填写 "否", "N", "NO", "FALSE", "0" 或留空

## 故障排除

### 常见问题及解决方案

#### 1. "无法连接到SolidWorks应用程序"
**原因**：SolidWorks未启动或API连接失败
**解决方案**：
- 确保SolidWorks完全启动
- 重启SolidWorks
- 检查SolidWorks版本兼容性

#### 2. "未找到BOM表"
**原因**：工程图中没有BOM表或BOM表格式不正确
**解决方案**：
- 在工程图中插入BOM表
- 检查BOM表是否包含必需的列
- 确保BOM表不是空表

#### 3. "循环引用检测"
**原因**：装配体结构中存在循环引用
**解决方案**：
- 检查装配体结构
- 消除循环引用
- 重新组织装配体层次

#### 4. "文件写入权限不足"
**原因**：目标目录没有写权限
**解决方案**：
- 以管理员身份运行SolidWorks
- 检查目录权限设置
- 更换输出目录

### 日志文件位置
- 默认位置：工程图同目录下的 `*_run.log` 文件
- 备用位置：`%TEMP%\ExportNestedBOM_*.log`

## 性能优化建议

### 1. 大型装配体处理
- 建议递归深度不超过8层
- 关闭不必要的SolidWorks插件
- 确保充足的内存和硬盘空间

### 2. 批量处理优化
- 按装配体大小分批处理
- 定期清理临时文件
- 监控系统资源使用情况

## 技术支持

### 联系方式
- 项目文档：`README.md`
- 测试指南：`test/测试指南.md`
- 日志分析：查看 `*_run.log` 文件

### 版本信息
- 当前版本：1.0.0
- 支持的SolidWorks版本：2019+
- 最后更新：2024年

## v1.0版本更新说明

### 新特性与改进
- 修复生产环境汇总表中文乱码问题（HTML输出编码改为gb2312）
- 支持"代号 名称.slddrw"格式的工程图文件查找
- BOM列识别支持"零件号"作为代号列关键词
- 优化错误处理和日志记录

### 升级注意事项
- 从旧版本升级时，请完整替换所有源码文件
- 升级后首次运行建议在测试环境验证功能
- 如有自定义修改，请注意合并您的更改

## 配置项：子装配参与性确认

- ConfirmSubAssemblyBOMBeforeExport（布尔，默认 true）
  - 是否在导出/统计前启用参与性确认弹窗
- Confirm_BlockOnSkipped（枚举：none/block，默认 none）
  - 发现 Skipped 状态时是否阻断流程
- Confirm_IncludeSkippedInSummary（布尔，默认 true）
  - 汇总中是否展示Skipped统计及指标
- Confirm_LogLevel（枚举：info/warn/error，默认 warn）
  - Skipped 类事件的日志级别
- Confirm_CsvEncoding（枚举：utf8/gbk，默认 utf8）
  - 导出CSV文件编码，以便与本地Excel兼容

注：以上配置项将在后续版本在 Configuration.bas/Constants.bas 中落地。