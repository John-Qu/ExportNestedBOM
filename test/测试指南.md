# 测试指南

## 测试环境设置

### 准备工作
1. 确保Windows虚拟机已安装SolidWorks 2019
2. 准备测试文件（基于用户提供的实际案例）：
   - `TS180-01Z-01Z四柱平台.slddrw`（顶层装配体工程图）
   - `TS180-01Z-02Z立柱平台.slddrw`（子装配体工程图）

### 测试数据结构分析

#### 顶层装配体BOM
```
项目号 | PART NUMBER | 数量 | 代号 | 名称 | ... | 是否组装
10 | TS180-01Z-004 | 1 | TS180-01Z-004 | 中空立柱 | ... | [空]
20 | TS180-01Z-005 | 1 | TS180-01Z-005 | 四眼小板 | ... | [空]  
30 | GB_FASTENER_WASHER_SWMC6 | 4 | [空] | Plain Washer—Product Grade C | ... | [空]
40 | GB_FASTENER_BOLT_HHBFTC M6X20-N | 4 | [空] | Hexagon Head Bolt—Full Thread—Product Grade C | ... | [空]
50 | TS180-01Z-03Z | 1 | TS180-01Z-03Z | 滚珠轴承 | ... | 是
```

#### 预期输出文件
1. `TS180-01Z-01Z四柱平台.xls` - 顶层BOM导出
2. `TS180-01Z-02Z立柱平台.xls` - 子装配体BOM导出  
3. `TS180-01Z-01Z四柱平台_汇总.xls` - 最终汇总表
4. `TS180-01Z-01Z四柱平台_run.log` - 运行日志

## 测试步骤

### 步骤1：基础功能测试
1. 在SolidWorks中打开VBA编辑器
2. 将源码文件内容复制到对应模块
3. 运行`Main.RunExportNestedBOM`
4. 选择`TS180-01Z-01Z四柱平台.slddrw`
5. 检查输出文件是否正确生成

### 步骤2：BOM识别测试  
验证程序能否正确识别各列：
- 项目号列（DOCUMENT PREVIEW）
- 代号列（PART NUMBER）  
- 数量列（数量）
- 名称列（PART NAME）
- 是否组装列（最右侧）

### 步骤3：递归测试
1. 确认识别到"TS180-01Z-03Z"行的"是否组装"列为"是"
2. 验证程序尝试打开"TS180-01Z-03Z.slddrw"
3. 如果文件存在，检查是否正确递归处理
4. 如果文件不存在，检查日志中的警告信息

### 步骤4：数量统计测试
基于用户提供的汇总数据验证：
```
零件代号: TS180-01Z-003 四孔平板 -> 预期总数量: 1
零件代号: TS180-01Z-004 中空立柱 -> 预期总数量: 4  
零件代号: TS180-01Z-005 四眼小板 -> 预期总数量: 4
零件代号: GB_FASTENER_WASHER_SWMC 6 -> 预期总数量: 17
零件代号: GB_FASTENER_BOLT_HHBFTC M6X20-N -> 预期总数量: 18
零件代号: TS180-01Z-03Z 滚珠轴承 -> 预期总数量: 4
```

### 步骤5：汇总表验证
检查生成的汇总表是否包含：
1. 正确的表头结构
2. 所有底层零件（非装配体）
3. 正确的总数量计算
4. 详细的计算过程记录

## 错误测试

### 测试循环引用
1. 人为修改BOM，使A装配体包含B，B装配体包含A
2. 验证程序能否检测并提示循环引用

### 测试缺失文件
1. 删除或重命名子装配体工程图文件
2. 验证程序能否正确处理并记录警告

### 测试列识别失败
1. 修改BOM表头，使用非标准列名
2. 验证程序的默认列处理逻辑

## 性能测试

### 大型装配体测试
- 测试包含多层嵌套（接近10层限制）的装配体
- 验证递归深度控制是否正常工作
- 检查内存使用和处理速度

### 批量零件测试  
- 测试包含大量底层零件的装配体
- 验证汇总统计的准确性和性能

## 预期结果验证

### 文件生成检查
- [ ] Excel文件能否在未激活的Excel 2016中正常打开
- [ ] 缩略图是否正确嵌入
- [ ] 表格格式是否保持一致

### 数据准确性检查
- [ ] 底层零件总数量是否与手工计算一致
- [ ] 计算过程记录是否完整清晰
- [ ] 是否遗漏或重复计算零件

### 日志完整性检查  
- [ ] 关键操作是否都有日志记录
- [ ] 错误和警告信息是否详细明确
- [ ] 日志时间戳是否正确

## 故障排除

### 常见问题及解决方案
1. **BOM表识别失败**：检查工程图中的表格是否为标准BOM格式
2. **列定位错误**：查看日志中的列识别信息，必要时手动调整代码中的默认列位置
3. **文件路径问题**：确保所有相关文件在同一目录，文件名与代号完全一致
4. **权限问题**：确保对输出目录有写入权限

### 调试技巧
1. 启用VBA调试模式，逐步执行代码
2. 在关键位置添加`Debug.Print`输出中间变量
3. 使用`MsgBox`显示关键信息确认程序执行路径
4. 检查`Err.Number`和`Err.Description`获取详细错误信息

## 测试报告模板

### 基本信息
- 测试时间：
- 测试环境：SolidWorks版本、Windows版本
- 测试文件：使用的装配体文件名

### 测试结果
- [ ] 基础功能正常
- [ ] BOM识别准确  
- [ ] 递归处理正确
- [ ] 数量统计准确
- [ ] 汇总表生成正确
- [ ] 错误处理正常

### 发现问题
列出测试过程中发现的问题和改进建议

### 性能表现
记录处理时间、内存使用等性能指标

          
# 在VBA中使用Debug.Print进行调试

在VBA中，你可以使用`Debug.Print`语句在立即窗口(Immediate Window)中显示调试信息。这是一种非常有效的方式来跟踪代码执行过程和变量值，而不会影响最终用户体验。

## 基本语法

```vba
Debug.Print 表达式
```

其中，表达式可以是变量、字符串、数字或它们的组合。

## 在你的项目中使用Debug.Print的示例

### 1. 显示简单变量值

```vba
Dim partNo As String: partNo = "TS180-01Z-003"
Debug.Print "零件代号: " & partNo
```

### 2. 在ProcessBOMRows函数中跟踪列识别

```vba
Debug.Print "列识别结果："
Debug.Print "  数量列索引: " & colQty
Debug.Print "  代号列索引: " & colPartNumber
Debug.Print "  名称列索引: " & colName
Debug.Print "  是否组装列索引: " & colAssemble
Debug.Print "  项目号列索引: " & colItemNumber
```

### 3. 跟踪子装配体工程图查找过程

```vba
Dim childDrw As String
childDrw = FindDrawingByPartCode(GetFileFolder(drawingPath), partNo)
Debug.Print "查找子装配体工程图:"
Debug.Print "  零件代号: " & partNo
Debug.Print "  查找目录: " & GetFileFolder(drawingPath)
Debug.Print "  查找结果: " & IIf(Len(childDrw) > 0, childDrw, "未找到")
```

### 4. 跟踪递归过程和分解链

```vba
Debug.Print String(depth * 2, "-") & "> 处理装配体: " & GetFileNameNoExt(drawingPath)
Debug.Print String(depth * 2, " ") & "  当前分解链: " & currentChain
```

### 5. 跟踪汇总统计

```vba
Debug.Print "添加到汇总: " & partNo & ", 数量: " & qty & ", 分解链: " & chain
```

## 查看调试输出

1. 在SolidWorks VBA编辑器中，按下`Ctrl+G`打开立即窗口
2. 运行你的宏，Debug.Print的输出会显示在立即窗口中

## 调试技巧

1. **使用分隔符增强可读性**：
   ```vba
   Debug.Print String(50, "=")  ' 打印50个等号作为分隔线
   Debug.Print "开始处理新装配体"
   Debug.Print String(50, "=")
   ```

2. **条件调试**：只在特定条件下打印
   ```vba
   If depth > 3 Then Debug.Print "深层递归: " & depth & ", 路径: " & drawingPath
   ```

3. **格式化数字**：
   ```vba
   Debug.Print "总数量: " & Format(totalQty, "#,##0")
   ```

4. **输出对象信息**：
   ```vba
   Debug.Print "BOM表行数: " & ta.RowCount & ", 列数: " & ta.ColumnCount
   ```

## 自定义属性批量添加/更新 功能测试
- 覆盖范围：单文件、批量、写入策略、字段来源、异常与边界
- 环境准备：导入 `frmProps.frm` 与 `UpdateProperties.bas`，确保可运行 `Run_AddCustomProps`

### 用例1：处理当前打开文件（单文件）
- 步骤：打开 `TS180-01Z-001 中空大框.SLDPRT` → 运行 → 选择“是”
- 操作：在窗体中修改“SUPPLIER=abc”，保持全选 → Add/Update
- 断言：
  - 文档级与配置特定均存在 SUPPLIER=abc
  - 质量字段可为空但不报错；是否钣金与实际一致

### 用例2：批量处理目录
- 步骤：运行 → 选择“否” → 选择 `test/MY2502_测试模型` 目录
- 断言：
  - 完成统计弹窗显示“总计/已更新/已跳过”
  - 所有处理成功文件均已保存

### 用例3：只读文件
- 准备：将单个零件文件设为只读
- 断言：提示失败/无法写入，不影响后续文件处理

### 用例4：部分取消
- 步骤：在第二个文件点击“Cancel”
- 断言：批量流程中止，统计弹窗包含“用户中止”

### 用例5：字段来源校验
- 准备：先手动在配置特定写入“型号=MODEL-A”
- 步骤：运行宏，确认窗体中“型号”应回显MODEL-A
- 断言：读取优先级“配置特定 > 自定义”生效


## 用例集：子装配参与性确认

场景装配（示意）：
- A（是否装配=是，存在工程图，含BOM）→ 期望 Included
- B（是否装配=是，无工程图）→ 期望 Skipped-NoDrawing
- C（是否装配=是，有工程图但无BOM表）→ 期望 Skipped-NoBOMTable
- D（应为“是”但漏标）→ 期望 Skipped-PropertyMissing
- E（是否装配=否或空）→ 期望不参与统计

步骤：
1) 打开顶层装配，运行导出/统计。
2) 在确认弹窗中检查各子装配状态与数量统计。
3) 导出CSV检查表，核对各状态行是否齐全、字段是否正确。
4) 切换阻断策略=“中止”，存在任一Skipped应中止并提示原因汇总。
5) 切换阻断策略=“继续”，应完成导出并在日志中记录所有Skipped条目。
6) 验证汇总中的覆盖率与差距指标与CSV一致。

验收：
- 全部状态判定正确；CSV与日志字段齐全；阻断策略生效；指标正确。

# Excel 2016 模块测试用例（BOM表整理与PDF + 总汇总

准备：
- 导入 excel 目录下全部 .bas 模块到 Excel 2016
- 打开测试数据：test/MY2502_测试模型/ 目录下的 Excel（如 TS180-01Z-01Z 四柱平台.xls 与 TS180-01Z-01Z 四柱平台_汇总.xls）

E1 列标题重命名与列重排（S3 + S4）
- 操作：运行 Main.Run_FormatAndExport_CurrentWorkbook
- 断言：
  - 标题中出现“组/购/加/钣/渠道/材料”，不存在“是否组装/是否外购/是否机加/是否钣金/SUPPLIER/材 料”
  - 列序应为 A..R：
    A 零件号, B 文档预览, C 序号, D 代号, E 名称, F 数量, G 材料, H 处理,
    I 渠道, J 型号, K 组, L 购, M 加, N 钣, O 备注, P 零件名称, Q 规格, R 标准

E2 布尔图标化（S5）
- 操作：检查 K/L/M/N 列（组/购/加/钣）
- 断言：仅出现“○/×”，混合输入“是/Yes/y/j/空白/否”等均被正确归一

E3 格式与打印设置（S6 + S7）
- 断言：
  - 字体应用主字体（不可用时自动回退至备用字体）
  - 对齐：左=代号/型号/处理/备注；右=数量；其余=居中
  - 打印区域=B:O；标题行重复第1行
  - 页眉：左=当前工作簿所在目录名，中=工作簿文件名，右=文件最后修改日期（yyyy-mm-dd）
  - 页脚：第 &[页码] 页，共 &[总页数] 页

E4 PDF 导出（S8）
- 操作：运行 Main.Run_FormatAndExport_CurrentWorkbook
- 断言：工作簿同级的 PDF/ 目录下，出现“[工作簿名]_[工作表名].pdf”文件；可正常打开
- 备注：未安装 PDFCreator 亦能导出单表 PDF；合并功能保留占位提示

E5 总汇总数量计算与“计算说明”（G1-G5）
- 操作：在“顶层装配体_汇总.xls”中运行 Main.Run_BuildSummary_And_Export
- 断言：
  - 生成“总 BOM 清单”工作表，列序与单表一致
  - 对于在多个子装配同时出现的代号 key，总数量为各子表数量之和
  - “计算说明”列显示形如“=2+3+1=6”的表达式（具体数值以样例数据为准）
  - 描述性字段（名称/型号/规格等）仅复制一次

E6 分类工作表（G6）
- 断言：
  - 生成“外购件/钣金件/机箱模型”工作表
  - 外购件：L=○；钣金件：N=○；机箱模型：名称包含任一关键词（默认：机箱/箱体）

E7 日志与容错（G7 + 异常）
- 断言：
  - logs/ 目录生成 run-*.txt，包含每步操作与警告/错误
  - 缺失列或映射表时不报错中断，日志有 WARN 提示且继续处理

附：快速回归命令（宏）：
- Main.Run_FormatAndExport_CurrentWorkbook
- Main.Run_BuildSummary_And_Export
- Main.Run_FullPipeline
